<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
      <div
        class="border-8 border-[#6653ff]  max-w-2xl mx-auto my-8 px-6 py-8"
      >
        <script src="https://unpkg.com/marked@2.1.3/lib/marked.js"></script>
        <script src="https://unpkg.com/lodash@4.17.21/lodash.min.js"></script>
        <script src="
https://cdn.jsdelivr.net/npm/slugify@1.6.6/slugify.min.js
"></script>
        <script src="./data.js"></script>
        <link href="./style.css" rel="stylesheet" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
          href="https://fonts.googleapis.com/css2?family=Newsreader:ital,opsz,wght@0,6..72,200..800;1,6..72,200..800&display=swap"
          rel="stylesheet"
        />

        <script src="./script.js" type="module">
          import { createApp } from 'https://unpkg.com/petite-vue?module';
          const ordinais = [
            '',
            'segunda',
            'terceira',
            'quarta',
            'quinta',
            'sexta',
            'sétima',
            'oitava',
            'nona',
            'décima',
            'décima primeira',
            'décima segunda',
            'décima terceira',
            'décima quarta',
            'décima quinta',
            'décima sexta',
            'décima sétima',
            'décima oitava',
            'décima nona',
            'vigésima'
          ];

          createApp({
            municipiosData,
            filteredMunicipios: _.orderBy(municipiosData, ['pop'], ['desc']),
            showList: true,
            input: '',
            selectedMunicipio: null,
            get compiledMarkdown() {
              return marked(this.input);
            },
            update: _.debounce(function (e) {
              if (e.target.value) {
                this.filterMunicipios(e.target.value);
              } else {
                this.filteredMunicipios = _.orderBy(municipiosData, ['pop'], ['desc']);
              }
              this.input = e.target.value;
              this.scrollListToTop()
            }, 100),
            scrollListToTop() {
              let el = document.getElementById('municipiosList');
              el.scrollTop = 0
            },
            filterMunicipios(value) {
                const filter = municipiosData.filter((mun) => {

                return (slugify(mun.municipio, { lower: true, replacement: '' }) +  slugify(mun.uf, { lower: true, replacement: '' })).includes(
                  slugify(value, { lower: true, replacement: '' })
                );
              });
              this.filteredMunicipios = _.orderBy(filter, ['pop'], ['desc'])
            },
            formatNumber(value) {
              if (parseInt(value) >= 1e6) {
                return `${Math.floor(parseInt(value) / 1e6)} ${Math.floor(parseInt(value) / 1e6) > 1 ? 'milhões' : 'milhão'} e ${Math.floor(parseInt(value % 1e6) / 1e3)} mil`
              }
              if (parseInt(value) > 1e3) {
                return (parseInt(value) / 1e3).toFixed(0) + ' mil'
              }
              return parseInt(value).toLocaleString()
            },
            setShowList: function () {
              this.showList = true;
              
            },
            selectMunicipio(value) {
              this.input = `${value.municipio} - ${value.uf}`;
              this.selectedMunicipio = value;
              this.showList = false
            },
            posicaoMunicipio(mun) {
              let posicao = _.indexOf(_.orderBy(this.municipiosData, ['pop'], ['desc']), mun)
              if (posicao <= 19) {
                return `é a ${ordinais[posicao]} cidade com maior população no Brasil`
              } 
              
              let posicaoNoEstado = _.indexOf(_.orderBy(this.municipiosData.filter(m => m.uf_id === mun.uf_id), ['pop'], ['desc']), mun)
              if (posicaoNoEstado <= 9) {
                return `é a ${ordinais[posicaoNoEstado]} cidade com maior população do estado ${estados[mun.uf].ref} ${estados[mun.uf].name}`
              }
              return `é considerada uma cidade ${parseInt(this.selectedMunicipio.pop) > 499999 ? 'grande' : parseInt(this.selectedMunicipio.pop) > 99999 ? 'média' : 'pequena'}`
                
              },
              totalEstado(mun) {
                return this.formatNumber(_.sum(this.municipiosData.filter(m => m.uf_id === mun.uf_id).map(m => m.pop)))
              }
          }).mount('#dataviz');
        </script>

        <div id="dataviz" class="text-[20px]">
          <div class="grid md:flex flex-row gap-5">
            <h1
              class="font-display text-[#111] w-full md:basis-1/2 text-3xl font-extrabold mb-5 font-actu"
            >
              Um <i>data center</i> consome mais energia que muita, muita
              gente...
            </h1>
            <p class="w-full md:basis-1/2 shrink-0 mb-12 text-lg text-pretty">
              Dados inéditos obtidos pelo
              <strong>Intercept Brasil</strong> indicam que, entre junho de 2023
              e abril de 2025, quando as bets começaram a ganhar mais tração no
              país, o número de auxílio-doença concedidos mensalmente por
              ludopatia aumentou mais de 2.300% — foram 276 benefícios
              concedidos no total no período.
            </p>
          </div>
          <p class="mb-5 font-bold text-2xl md:text-3xl font-actu text-[#6653ff]"">Quanto tempo sua cidade levaria para consumir a energia do data center do TikTok?</p>
          <div class="relative">
            <svg data-v-3bab6120="" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search-icon lucide-search search-icon opacity-50 absolute left-3 top-5 w-6 h-6"><path d="m21 21-4.34-4.34"></path><circle cx="11" cy="11" r="8"></circle></svg>
            <input
              type="text"
              class="border border-neutral-200 h-16 px-3 pl-12 flex items-center w-full leading-0 font-actu-mono text-base"
              :value="input"
              @input="update"
              @focus="setShowList"
              placeholder="Digite o nome da sua cidade"
            />

            <ul
              v-if="showList"
              id="municipiosList"
              class="bg-white border border-neutral-200 border-t-0 shadow-md sm:shadow-lg max-h-32 lg:max-h-42 w-full overflow-y-auto left-0"
            >
              <li
                v-for="item in filteredMunicipios.slice(0,50)"
                :key="item.municipio_id"
                class="hover:bg-neutral-200 py-1.5 px-3 cursor-pointer tracking-wide duration-150 text-sm font-actu-mono"
                @click="selectMunicipio(item)"
                :class="{'text-[#6653ff]': selectedMunicipio.municipio_id === item.municipio_id}"
              >
                {{ item.municipio }} - {{item.uf}}
              </li>
            </ul>
          </div>
          <article v-if="selectedMunicipio !== null" class="mt-8">
            <h2 class="font-bold font-actu text-[#111] text-2xl mb-2 flex items-center gap-4"><span class="h-[10px] w-[70px] bg-[#111]"></span><span>{{selectedMunicipio.municipio}} - {{selectedMunicipio.uf}}</span></h2>
            <p class="mb-3">Tem uma população de <strong>{{formatNumber(selectedMunicipio.pop)}}</strong> pessoas e {{posicaoMunicipio(selectedMunicipio)}}.</p>
            <p class="font-bold font-actu text=[#111]">A cidade de {{selectedMunicipio.municipio}} {{(consumoAnualDC /(estados[selectedMunicipio.uf].consumo_por_hab * selectedMunicipio.pop)).toFixed(2)}}</p>
            <p v-if="selectedMunicipio.uf !== 'DF'" class="my-3 text-sm">A populaçao do estado {{estados[selectedMunicipio.uf].ref}} {{estados[selectedMunicipio.uf].name}} é de {{totalEstado(selectedMunicipio)}} pessoas.</p>

          </article>
        </div>

        <style>
          /* Colar aqui os estilos */
        </style>
      </div>
  </body>
</html>
